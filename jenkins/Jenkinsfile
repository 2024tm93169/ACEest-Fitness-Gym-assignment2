pipeline {
  agent any

  environment {
    DOCKERHUB_CREDENTIALS = credentials('dockerhub-creds')   // set this in Jenkins
    DOCKERHUB_REPO = '2024tm93169/aceest-fitness-gym'
    SONARQUBE_SERVER = 'My SonarQube Server'                 // configure in Jenkins
  }

  options {
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/2024tm93169/ACEest-Fitness-Gym-assignment2.git'
      }
    }

    stage('Setup Python') {
      steps {
        sh 'python --version || true'
        sh 'pip --version || true'
        sh 'pip install -r requirements.txt'
      }
    }

    stage('Unit Tests (Pytest across all versions)') {
      steps {
        sh 'pytest -q --maxfail=1 --disable-warnings tests/'
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: 'tests/*.xml'
        }
      }
    }

    stage('Code Quality (SonarQube)') {
      steps {
        withSonarQubeEnv('My SonarQube Server') {
          sh 'sonar-scanner || true'  // allow to run even if not fully configured yet
        }
      }
      post {
        always {
          script {
            try {
              timeout(time: 2, unit: 'MINUTES') {
                waitForQualityGate abortPipeline: false
              }
            } catch (e) {
              echo "Quality Gate check skipped or failed: ${e}"
            }
          }
        }
      }
    }

    stage('Build & Push Docker Images (all versions)') {
      steps {
        script {
          def versions = [
            ["1","app/ACEest_Fitness.py"],
            ["1.1","app/ACEest_Fitness-V1.1.py"],
            ["1.2","app/ACEest_Fitness-V1.2.py"],
            ["1.2.1","app/ACEest_Fitness-V1.2.1.py"],
            ["1.2.2","app/ACEest_Fitness-V1.2.2.py"],
            ["1.2.3","app/ACEest_Fitness-V1.2.3.py"],
            ["1.3","app/ACEest_Fitness-V1.3.py"]
          ]

          docker.withRegistry('https://registry.hub.docker.com', DOCKERHUB_CREDENTIALS) {
            for (v in versions) {
              def tag = v[0]; def appFile = v[1];
              sh "echo Building ${DOCKERHUB_REPO}:${tag} from ${appFile}"
              sh "docker build --build-arg APP_FILE=${appFile} -t ${DOCKERHUB_REPO}:${tag} ."
              sh "docker push ${DOCKERHUB_REPO}:${tag}"
            }
            sh "docker tag ${DOCKERHUB_REPO}:1.3 ${DOCKERHUB_REPO}:latest"
            sh "docker push ${DOCKERHUB_REPO}:latest"
          }
        }
      }
    }

    stage('Deploy to Minikube (Kubernetes)') {
      steps {
        sh 'kubectl apply -f k8s/blue-green/'
        sh 'kubectl apply -f k8s/canary/'
        sh 'kubectl apply -f k8s/ab-testing/'
        sh 'kubectl apply -f k8s/rolling-update/'
        sh 'kubectl apply -f k8s/shadow/ || true' // requires Istio
      }
    }
  }

  post {
    success { echo "CI/CD pipeline completed successfully." }
    failure { echo "Pipeline failed. Check logs." }
  }
}
